'use strict';

(function () {

    var waitCalls = 0;

    function showWait() {
        waitCalls++;
        if (waitCalls === 1) {
            $('.loader-frame').fadeIn();
        }
    }

    function hideWait() {
        waitCalls--;
        if (waitCalls === 0) {
            $('.loader-frame').fadeOut();
        }
    }

    angular.module('megabyte.funny-pets').controller('BooksController', function ($http, $timeout, $rootScope, $window, $controller) {

        var userController = $controller('UserController');

        var controller = this;
        controller.tab = 'all';
        controller.showLoader = 0;

        controller.findedBooks = [];

        controller.wantBooks = [];
        controller.myBooks = [];
        controller.allBooks = [];

        controller.newNameChanged = function () {

            if (controller.newName && controller.newName.length > 2) {

                showWait();
                $http.get('/api/book?newBookName=' + controller.newName).then(function (res) {

                    hideWait();
                    if (res.data && res.data.length) {
                        controller.findedBooks = res.data;
                    }
                }, hideWait);
            } else {
                controller.findedBooks = [];
            }
        };

        controller.deleteBook = function (book) {
            showWait();
            $http.delete('/api/book/' + book._id).then(function (res) {
                renewMyBooks();
                hideWait();
            }, hideWait);
        };

        controller.borrowBook = function (book) {
            if ($rootScope.loggedIn) {
                showWait();
                $http.post('/api/book/' + book._id).then(function (res) {
                    renewAllBooks();
                    renewBooksIWant();
                    hideWait();
                }, hideWait);
            } else {
                userController.loginClick();
            }
        };

        controller.returnBook = function (book) {
            showWait();
            $http.get('/api/book/return/' + book._id).then(function (res) {
                renewAllBooks();
                renewBooksIWant();
                hideWait();
            }, hideWait);
        };

        controller.approveBook = function (book) {
            showWait();
            $http.get('/api/book/approve/' + book._id).then(function (res) {
                renewMyBooks();
                hideWait();
            }, hideWait);
        };

        controller.refuseBook = function (book) {
            showWait();
            $http.get('/api/book/refuse/' + book._id).then(function (res) {
                renewMyBooks();
                hideWait();
            }, hideWait);
        };

        function renewMyBooks() {
            if ($rootScope.loggedIn) {
                showWait();
                $http.get('/api/book?myBooks=1').then(function (res) {
                    hideWait();
                    controller.myBooks = res.data;
                    controller.myBooks.sort(function (a, b) {
                        if (a.borrowUserId) {
                            if (!b.borrowUserId) {
                                return -1;
                            } else {

                                if (a.borrowApproved && !b.borrowApproved) {
                                    return 1;
                                } else if (!a.borrowApproved && b.borrowApproved) {
                                    return -1;
                                }
                            }
                        } else {
                            if (b.borrowUserId) {
                                return 1;
                            }
                        }
                        return 0;
                    });

                    controller.approvNeedCount = controller.myBooks.filter(function (b) {
                        return b.borrowUserId && !b.borrowApproved;
                    }).length;
                }, hideWait);
            }
        }

        function renewBooksIWant() {
            if ($rootScope.loggedIn) {
                showWait();
                $http.get('/api/book?booksIWant=1').then(function (res) {
                    hideWait();
                    controller.wantBooks = res.data;
                }, hideWait);
            }
        }

        $rootScope.$watch('[loggedIn]', function (newValue, oldValue) {
            if (newValue) {
                renewMyBooks();
                renewBooksIWant();
            } else {
                controller.myBooks = [];
            }
        }, true);

        function renewAllBooks() {
            showWait();
            $http.get('/api/book').then(function (res) {
                hideWait();
                controller.allBooks = res.data;
            }, hideWait);
        }
        renewAllBooks();

        controller.clearSearch = function () {
            controller.findedBooks = [];
            controller.newName = '';
        };

        controller.clickFinded = function (item) {
            controller.findedBooks.splice(controller.findedBooks.indexOf(item), 1);

            showWait();
            $http.post('/api/book', {
                'id': item.id
            }).then(function (res) {
                renewMyBooks();
                hideWait();
            }, hideWait);
        };

        function recalcContainerPos() {

            $('.grid').css('width', '');

            $('.grid').masonry({
                // options
                itemSelector: '.grid-item',
                columnWidth: 210
            });

            var w = $('.grid').width();

            var targetW = Math.floor(w / 210) * 210 + 40;

            $('.grid').css('width', '' + targetW + 'px');
        }

        $(window).resize(recalcContainerPos);
        recalcContainerPos();
    });
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBldHNDb250cm9sbGVyLmNsaWVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBS2IsQ0FBQyxZQUFXOztBQUVSLFFBQUksU0FBUyxHQUFHLENBQUMsQ0FBQzs7QUFFbEIsYUFBUyxRQUFRLEdBQUc7QUFDaEIsaUJBQVMsRUFBRSxDQUFDO0FBQ1osWUFBSSxTQUFTLEtBQUssQ0FBQyxFQUFFO0FBQ2pCLGFBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUMvQjtLQUNKOztBQUVELGFBQVMsUUFBUSxHQUFHO0FBQ2hCLGlCQUFTLEVBQUUsQ0FBQztBQUNaLFlBQUksU0FBUyxLQUFLLENBQUMsRUFBRTtBQUNqQixhQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7U0FDaEM7S0FDSjs7QUFHRCxXQUFPLENBQUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBRXBDLFVBQVUsQ0FBQyxpQkFBaUIsRUFBRSxVQUFTLEtBQUssRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUU7O0FBR3ZGLFlBQUksY0FBYyxHQUFHLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDOztBQUduRCxZQUFJLFVBQVUsR0FBRyxJQUFJLENBQUM7QUFDdEIsa0JBQVUsQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDO0FBQ3ZCLGtCQUFVLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQzs7QUFFMUIsa0JBQVUsQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDOztBQUU1QixrQkFBVSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7QUFDMUIsa0JBQVUsQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO0FBQ3hCLGtCQUFVLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQzs7QUFJekIsa0JBQVUsQ0FBQyxjQUFjLEdBQUcsWUFBVzs7QUFHbkMsZ0JBQUksVUFBVSxDQUFDLE9BQU8sSUFBSyxVQUFVLENBQUMs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LENBQUM7QUFDZix3QkFBUSxFQUFFLENBQUM7YUFDZCxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQ2hCLENBQUE7O0FBS0QsaUJBQVMsa0JBQWtCLEdBQUU7O0FBRXhCLGFBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDOztBQUU1QixhQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDOztBQUVsQiw0QkFBWSxFQUFFLFlBQVk7QUFDMUIsMkJBQVcsRUFBRSxHQUFHO2FBQ2pCLENBQUMsQ0FBQzs7QUFFSCxnQkFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDOztBQUUzQixnQkFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUMsR0FBRyxDQUFDLEdBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQzs7QUFFMUMsYUFBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsRUFBRSxHQUFDLE9BQU8sR0FBQyxJQUFJLENBQUMsQ0FBQztTQUczQzs7QUFFRCxTQUFDLENBQUUsTUFBTSxDQUFFLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDdkMsMEJBQWtCLEVBQUUsQ0FBQztLQUV4QixDQUFDLENBQUM7Q0FHTixDQUFBLEVBQUcsQ0FBQyIsImZpbGUiOiJwZXRzQ29udHJvbGxlci5jbGllbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cblxuXG5cbihmdW5jdGlvbigpIHtcblxuICAgIHZhciB3YWl0Q2FsbHMgPSAwO1xuXG4gICAgZnVuY3Rpb24gc2hvd1dhaXQoKSB7XG4gICAgICAgIHdhaXRDYWxscysrO1xuICAgICAgICBpZiAod2FpdENhbGxzID09PSAxKSB7XG4gICAgICAgICAgICAkKCcubG9hZGVyLWZyYW1lJykuZmFkZUluKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBoaWRlV2FpdCgpIHtcbiAgICAgICAgd2FpdENhbGxzLS07XG4gICAgICAgIGlmICh3YWl0Q2FsbHMgPT09IDApIHtcbiAgICAgICAgICAgICQoJy5sb2FkZXItZnJhbWUnKS5mYWRlT3V0KCk7XG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIGFuZ3VsYXIubW9kdWxlKCdtZWdhYnl0ZS5mdW5ueS1wZXRzJylcblxuICAgIC5jb250cm9sbGVyKCdCb29rc0NvbnRyb2xsZXInLCBmdW5jdGlvbigkaHR0cCwgJHRpbWVvdXQsICRyb290U2NvcGUsICR3aW5kb3csICRjb250cm9sbGVyKSB7XG5cblxuICAgICAgICB2YXIgdXNlckNvbnRyb2xsZXIgPSAkY29udHJvbGxlcignVXNlckNvbnRyb2xsZXInKTtcblxuXG4gICAgICAgIHZhciBjb250cm9sbGVyID0gdGhpcztcbiAgICAgICAgY29udHJvbGxlci50YWIgPSAnYWxsJztcbiAgICAgICAgY29udHJvbGxlci5zaG93TG9hZGVyID0gMDtcbiAgICAgICAgXG4gICAgICAgIGNvbnRyb2xsZXIuZmluZGVkQm9va3MgPSBbXTtcbiAgICAgICAgXG4gICAgICAgIGNvbnRyb2xsZXIud2FudEJvb2tzID0gW107XG4gICAgICAgIGNvbnRyb2xsZXIubXlCb29rcyA9IFtdO1xuICAgICAgICBjb250cm9sbGVyLmFsbEJvb2tzID0gW107XG5cblxuXG4gICAgICAgIGNvbnRyb2xsZXIubmV3TmFtZUNoYW5nZWQgPSBmdW5jdGlvbigpIHtcblxuXG4gICAgICAgICAgICBpZiAoY29udHJvbGxlci5uZXdOYW1lICYmIChjb250cm9sbGVyLm5ld05hbWUubGVuZ3RoID4gMikpIHtcblxuICAgICAgICAgICAgICAgIHNob3dXYWl0KCk7XG4gICAgICAgICAgICAgICAgJGh0dHAuZ2V0KCcvYXBpL2Jvb2s/bmV3Qm9va05hbWU9JyArIGNvbnRyb2xsZXIubmV3TmFtZSkudGhlbihmdW5jdGlvbihyZXMpIHtcblxuICAgICAgICAgICAgICAgICAgICBoaWRlV2FpdCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEgJiYgcmVzLmRhdGEubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyLmZpbmRlZEJvb2tzID0gcmVzLmRhdGE7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH0sIGhpZGVXYWl0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIuZmluZGVkQm9va3MgPSBbXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICAgICAgY29udHJvbGxlci5kZWxldGVCb29rID0gZnVuY3Rpb24oYm9vaykge1xuICAgICAgICAgICAgc2hvd1dhaXQoKTtcbiAgICAgICAgICAgICRodHRwLmRlbGV0ZSgnL2FwaS9ib29rLycrYm9vay5faWQpLnRoZW4oZnVuY3Rpb24ocmVzKSB7XG4gICAgICAgICAgICAgICAgcmVuZXdNeUJvb2tzKCk7XG4gICAgICAgICAgICAgICAgaGlkZVdhaXQoKTtcblxuICAgICAgICAgICAgfSwgaGlkZVdhaXQpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb250cm9sbGVyLmJvcnJvd0Jvb2sgPSBmdW5jdGlvbihib29rKSB7XG4gICAgICAgICAgICBpZigkcm9vdFNjb3BlLmxvZ2dlZEluKSB7XG4gICAgICAgICAgICAgICAgc2hvd1dhaXQoKTtcbiAgICAgICAgICAgICAgICAkaHR0cC5wb3N0KCcvYXBpL2Jvb2svJytib29rLl9pZCkudGhlbihmdW5jdGlvbihyZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVuZXdBbGxCb29rcygpO1xuICAgICAgICAgICAgICAgICAgICByZW5ld0Jvb2tzSVdhbnQoKTtcbiAgICAgICAgICAgICAgICAgICAgaGlkZVdhaXQoKTtcbiAgICAgICAgICAgICAgICB9LCBoaWRlV2FpdCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHVzZXJDb250cm9sbGVyLmxvZ2luQ2xpY2soKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgY29udHJvbGxlci5yZXR1cm5Cb29rID0gZnVuY3Rpb24oYm9vaykge1xuICAgICAgICAgICBzaG93V2FpdCgpO1xuICAgICAgICAgICAkaHR0cC5nZXQoJy9hcGkvYm9vay9yZXR1cm4vJytib29rLl9pZCkudGhlbihmdW5jdGlvbihyZXMpIHtcbiAgICAgICAgICAgICAgcmVuZXdBbGxCb29rcygpO1xuICAgICAgICAgICAgICByZW5ld0Jvb2tzSVdhbnQoKTtcbiAgICAgICAgICAgICAgaGlkZVdhaXQoKTtcbiAgICAgICAgICAgfSwgaGlkZVdhaXQpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb250cm9sbGVyLmFwcHJvdmVCb29rID0gZnVuY3Rpb24oYm9vaykge1xuICAgICAgICAgICBzaG93V2FpdCgpO1xuICAgICAgICAgICAkaHR0cC5nZXQoJy9hcGkvYm9vay9hcHByb3ZlLycrYm9vay5faWQpLnRoZW4oZnVuY3Rpb24ocmVzKSB7XG4gICAgICAgICAgICAgIHJlbmV3TXlCb29rcygpO1xuICAgICAgICAgICAgICBoaWRlV2FpdCgpO1xuICAgICAgICAgICB9LCBoaWRlV2FpdCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGNvbnRyb2xsZXIucmVmdXNlQm9vayA9IGZ1bmN0aW9uKGJvb2spIHtcbiAgICAgICAgICAgc2hvd1dhaXQoKTtcbiAgICAgICAgICAgJGh0dHAuZ2V0KCcvYXBpL2Jvb2svcmVmdXNlLycrYm9vay5faWQpLnRoZW4oZnVuY3Rpb24ocmVzKSB7XG4gICAgICAgICAgICAgIHJlbmV3TXlCb29rcygpO1xuICAgICAgICAgICAgICBoaWRlV2FpdCgpO1xuICAgICAgICAgICB9LCBoaWRlV2FpdCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgXG5cblxuICAgICAgICBmdW5jdGlvbiByZW5ld015Qm9va3MoKSB7XG4gICAgICAgICAgICBpZigkcm9vdFNjb3BlLmxvZ2dlZEluKSB7XG4gICAgICAgICAgICAgICAgc2hvd1dhaXQoKTtcbiAgICAgICAgICAgICAgICAkaHR0cC5nZXQoJy9hcGkvYm9vaz9teUJvb2tzPTEnKS50aGVuKGZ1bmN0aW9uKHJlcykge1xuICAgICAgICAgICAgICAgICAgICBoaWRlV2FpdCgpO1xuICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyLm15Qm9va3MgPSByZXMuZGF0YTtcbiAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlci5teUJvb2tzLnNvcnQoZnVuY3Rpb24oYSxiKXtcbiAgICAgICAgICAgICAgICAgICAgICAgaWYoYS5ib3Jyb3dVc2VySWQpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWIuYm9ycm93VXNlcklkKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihhLmJvcnJvd0FwcHJvdmVkICYmICFiLmJvcnJvd0FwcHJvdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWEuYm9ycm93QXBwcm92ZWQgJiYgYi5ib3Jyb3dBcHByb3ZlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoYi5ib3Jyb3dVc2VySWQpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIuYXBwcm92TmVlZENvdW50ID0gY29udHJvbGxlci5teUJvb2tzLmZpbHRlcihmdW5jdGlvbihiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYi5ib3Jyb3dVc2VySWQgJiYgIWIuYm9ycm93QXBwcm92ZWQ7XG4gICAgICAgICAgICAgICAgICAgIH0pLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0sIGhpZGVXYWl0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgZnVuY3Rpb24gcmVuZXdCb29rc0lXYW50KCkge1xuICAgICAgICAgICAgaWYoJHJvb3RTY29wZS5sb2dnZWRJbikgeyAgICAgICAgXG4gICAgICAgICAgICAgICAgc2hvd1dhaXQoKTtcbiAgICAgICAgICAgICAgICAkaHR0cC5nZXQoJy9hcGkvYm9vaz9ib29rc0lXYW50PTEnKS50aGVuKGZ1bmN0aW9uKHJlcykge1xuICAgICAgICAgICAgICAgICAgICBoaWRlV2FpdCgpO1xuICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyLndhbnRCb29rcyA9IHJlcy5kYXRhO1xuICAgICAgICAgICAgICAgIH0sIGhpZGVXYWl0KTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgJHJvb3RTY29wZS4kd2F0Y2goJ1tsb2dnZWRJbl0nLCBmdW5jdGlvbiAobmV3VmFsdWUsIG9sZFZhbHVlKSB7XG4gICAgICAgICAgIGlmKG5ld1ZhbHVlKXtcbiAgICAgICAgICAgICAgcmVuZXdNeUJvb2tzKCk7XG4gICAgICAgICAgICAgIHJlbmV3Qm9va3NJV2FudCgpO1xuICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgY29udHJvbGxlci5teUJvb2tzID0gW107XG4gICAgICAgICAgIH1cbiAgICAgICAgfSwgdHJ1ZSk7XG4gICAgICAgIFxuICAgICAgICBmdW5jdGlvbiByZW5ld0FsbEJvb2tzKCkge1xuICAgICAgICAgICAgc2hvd1dhaXQoKTtcbiAgICAgICAgICAgICRodHRwLmdldCgnL2FwaS9ib29rJykudGhlbihmdW5jdGlvbihyZXMpIHtcbiAgICAgICAgICAgICAgICBoaWRlV2FpdCgpO1xuICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIuYWxsQm9va3MgPSByZXMuZGF0YTtcbiAgICAgICAgICAgIH0sIGhpZGVXYWl0KTtcbiAgICAgICAgfVxuICAgICAgICByZW5ld0FsbEJvb2tzKCk7XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBjb250cm9sbGVyLmNsZWFyU2VhcmNoID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZmluZGVkQm9va3MgPSBbXTtcbiAgICAgICAgICAgIGNvbnRyb2xsZXIubmV3TmFtZSA9Jyc7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGNvbnRyb2xsZXIuY2xpY2tGaW5kZWQgPSBmdW5jdGlvbihpdGVtKSB7XG4gICAgICAgICAgICBjb250cm9sbGVyLmZpbmRlZEJvb2tzLnNwbGljZShjb250cm9sbGVyLmZpbmRlZEJvb2tzLmluZGV4T2YoaXRlbSksIDEpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBzaG93V2FpdCgpO1xuICAgICAgICAgICAgJGh0dHAucG9zdCgnL2FwaS9ib29rJywge1xuICAgICAgICAgICAgICAgICdpZCc6IGl0ZW0uaWRcbiAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24ocmVzKSB7XG4gICAgICAgICAgICAgICAgcmVuZXdNeUJvb2tzKCk7XG4gICAgICAgICAgICAgICAgaGlkZVdhaXQoKTtcbiAgICAgICAgICAgIH0sIGhpZGVXYWl0KTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgXG4gICAgICAgIFxuICAgICAgICBmdW5jdGlvbiByZWNhbGNDb250YWluZXJQb3MoKXtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgICQoJy5ncmlkJykuY3NzKCd3aWR0aCcsICcnKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgICQoJy5ncmlkJykubWFzb25yeSh7XG4gICAgICAgICAgICAgIC8vIG9wdGlvbnNcbiAgICAgICAgICAgICAgaXRlbVNlbGVjdG9yOiAnLmdyaWQtaXRlbScsXG4gICAgICAgICAgICAgIGNvbHVtbldpZHRoOiAyMTBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciB3ID0gJCgnLmdyaWQnKS53aWR0aCgpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB2YXIgdGFyZ2V0VyA9IE1hdGguZmxvb3Iody8yMTApKjIxMCArIDQwO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICQoJy5ncmlkJykuY3NzKCd3aWR0aCcsICcnK3RhcmdldFcrJ3B4Jyk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAkKCB3aW5kb3cgKS5yZXNpemUocmVjYWxjQ29udGFpbmVyUG9zKTtcbiAgICAgICAgcmVjYWxjQ29udGFpbmVyUG9zKCk7XG5cbiAgICB9KTtcblxuXG59KSgpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
